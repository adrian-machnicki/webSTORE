-- TABLE users
CREATE TABLE users (
	id						INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1, INCREMENT BY 1) PRIMARY KEY,
	username				VARCHAR(25) NOT NULL UNIQUE,
	first_name				VARCHAR(50),
	second_name				VARCHAR(50),
	last_name				VARCHAR(70),
	password				VARCHAR(70) NOT NULL,
	email					VARCHAR(50) NOT NULL UNIQUE,
	user_details_id			INTEGER,
	enabled					TINYINT NOT NULL
);
CREATE INDEX users_username ON users (username);


-- TABLE authorities
CREATE TABLE authorities (
	id						INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1, INCREMENT BY 1) PRIMARY KEY,
	username				VARCHAR(25) NOT NULL,
	authority				VARCHAR(20) NOT NULL,
	
	UNIQUE (username, authority)
);
CREATE INDEX authorities_username ON authorities (username);

-- TABLE user_details
CREATE TABLE user_details (

	id						INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1, INCREMENT BY 1) PRIMARY KEY,
	address					VARCHAR(255),
	city					VARCHAR(50)
);
CREATE INDEX user_details_id ON user_details (id);


-- TABLE books
CREATE TABLE books (
	id						INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1, INCREMENT BY 1) PRIMARY KEY,
	title					VARCHAR(120),
	book_details_id 		INTEGER,
	price					FLOAT,
	amount					INTEGER
);
CREATE INDEX books_title ON books (title);


-- TABLE authors
CREATE TABLE authors (
	id						INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1, INCREMENT BY 1) PRIMARY KEY,
	first_name				VARCHAR(50),
	last_name  				VARCHAR_IGNORECASE(50)
);
CREATE INDEX authors_last_name ON authors (last_name);


-- TABLE books_authors <MANY TO MANY>
CREATE TABLE books_authors (
	book_id					INTEGER,
	author_id 				INTEGER
);


-- TABLE book_details
CREATE TABLE book_details (
	id						INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1, INCREMENT BY 1) PRIMARY KEY,
	pages					INTEGER,
	description				VARCHAR(4096)
);


-- TABLE orders
CREATE TABLE orders (
	id						INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1, INCREMENT BY 1) PRIMARY KEY,
	amount					FLOAT,
	user_id					INTEGER,
	shipping_details_id		INTEGER,
	date					TIMESTAMP,
	paid					BOOLEAN DEFAULT FALSE NOT NULL,
	sent					BOOLEAN DEFAULT FALSE NOT NULL
);
CREATE INDEX orders_user_id ON orders (user_id);


-- TABLE order_records
CREATE TABLE order_records (
	id						INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1, INCREMENT BY 1) PRIMARY KEY,
	quantity				INTEGER,
	price					FLOAT,
	amount					INTEGER,
	book_id					INTEGER,
	order_id				INTEGER
);
CREATE INDEX order_records_order_id ON order_records (order_id);


-- TABLE shipping_details
CREATE TABLE shipping_details (
	id						INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1, INCREMENT BY 1) PRIMARY KEY,
	first_name				VARCHAR(25),
	second_name				VARCHAR(25),
	last_name				VARCHAR(50),
	email					VARCHAR(50),
	address					VARCHAR(255),
	city					VARCHAR(50)
);
CREATE INDEX shipping_details_id ON shipping_details (id);


-- ADD CONSTRAINTS

ALTER TABLE users
	ADD CONSTRAINT fk_users_user_details_id
	FOREIGN KEY(user_details_id)
	REFERENCES user_details(id);	

ALTER TABLE authorities
	ADD CONSTRAINT fk_authorities_username
	FOREIGN KEY(username)
	REFERENCES users(username);	

ALTER TABLE books
	ADD CONSTRAINT fk_books_book_details_id
	FOREIGN KEY(book_details_id)
	REFERENCES book_details(id);

ALTER TABLE books_authors
	ADD CONSTRAINT fk_books_authors_book_id
	FOREIGN KEY(book_id)
	REFERENCES books(id);
	
ALTER TABLE books_authors
	ADD CONSTRAINT fk_books_authors_author_id
	FOREIGN KEY(author_id)
	REFERENCES authors(id);
	
ALTER TABLE orders
	ADD CONSTRAINT fk_order_user_id
	FOREIGN KEY(user_id)
	REFERENCES users(id);
	
ALTER TABLE orders
	ADD CONSTRAINT fk_order_shipping_details_id
	FOREIGN KEY(shipping_details_id)
	REFERENCES shipping_details(id);
	
ALTER TABLE order_records
	ADD CONSTRAINT fk_order_records_book_id
	FOREIGN KEY(book_id)
	REFERENCES books(id);
	
ALTER TABLE order_records
	ADD CONSTRAINT fk_order_records_order_id
	FOREIGN KEY(order_id)
	REFERENCES orders(id);	
